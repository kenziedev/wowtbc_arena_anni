name: Process Submission

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pages: write
  id-token: write

concurrency:
  group: data-update
  cancel-in-progress: false

jobs:
  process:
    if: >-
      (github.event.action == 'labeled' && github.event.label.name == 'add-source') ||
      (github.event.action == 'opened' && startsWith(github.event.issue.title, '[추가]'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt

      - name: Process submission
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          BLIZZARD_CLIENT_ID: ${{ secrets.BLIZZARD_CLIENT_ID }}
          BLIZZARD_CLIENT_SECRET: ${{ secrets.BLIZZARD_CLIENT_SECRET }}
        run: python scripts/process_submission.py

      - name: Commit and push config changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/sources.json
          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "chore: add sources from issue #${{ github.event.issue.number }}"
            for i in 1 2 3; do
              git pull --rebase origin main && git push && break
              echo "Push attempt $i failed, retrying..."
              sleep 5
            done
          fi

      - name: Fetch new entries only (incremental)
        env:
          BLIZZARD_CLIENT_ID: ${{ secrets.BLIZZARD_CLIENT_ID }}
          BLIZZARD_CLIENT_SECRET: ${{ secrets.BLIZZARD_CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: python scripts/fetch_incremental.py

      - name: Commit and push leaderboard data
        run: |
          git add data/ icons/
          git rm -f --cached config/_added.json 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "No data changes"
          else
            git commit -m "chore: update leaderboard after adding sources from #${{ github.event.issue.number }}"
            for i in 1 2 3; do
              git pull --rebase origin main && git push && break
              echo "Push attempt $i failed, retrying..."
              sleep 5
            done
          fi

      - name: Close issue with comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body;
            try {
              const diff = require('child_process').execSync('git diff HEAD~1 -- config/sources.json', {encoding: 'utf-8'});
              if (diff.includes('+')) {
                body = '등록이 완료되었습니다! 리더보드에 반영되었습니다. ✅';
              } else {
                body = '요청하신 항목이 이미 등록되어 있거나 존재하지 않는 길드/캐릭터입니다. ❌\n\n이름을 다시 확인해 주세요.';
              }
            } catch {
              body = '처리가 완료되었습니다.';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

  deploy:
    needs: process
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    concurrency:
      group: pages
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
